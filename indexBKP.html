<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>


        <style>

            text {
                font: 11px sans-serif;
                cursor: pointer;
            }

            /*    body {
                    width: 880px;
                    margin: 0 auto;
                }*/

            h1 {
                text-align: center;
                margin: .5em 0;
            }

            p#intro {
                text-align: center;
                margin: 1em 0;
            }

            body{
                background-image: url('fundo.png');
                background-repeat: no-repeat;
            }

            svg{
                margin-top: 40px;
                margin-left: 180px;
            }

            path {
                stroke: #fff;
                stroke-width: 0.5;
                cursor: pointer;
            }

        </style>
        <script src="d3.v3.min.js" type="text/javascript"></script>
        <script>

            var width = 860,
                    height = width;//700,
            radius = width / 2;//(Math.min(width, height) / 2) -10;

            var x = d3.scale.linear()
                    .range([0, 2 * Math.PI]);

            // var y = d3.scale.sqrt().range([0, radius]);
            y = d3.scale.pow().exponent(1.3).domain([0, 1]).range([0, radius]),
                    padding = 5,
                    duration = 1000;

            var color = d3.scale.category20c();//category10();

            var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ") rotate(-90 0 0)");

            var partition = d3.layout.partition()
                    .value(function (d) {
                        return d.size;
                    });

            var arc = d3.svg.arc()
                    .startAngle(function (d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
                    })
                    .endAngle(function (d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
                    })
                    .innerRadius(function (d) {
                        return Math.max(0, y(d.y));
                    })
                    .outerRadius(function (d) {
                        return Math.max(0, y(d.y + d.dy));
                    });

//d3.json("/d/4063550/flare.json", function(error, root) {
            var root = getData();

            var g = svg.selectAll("g")
                    .data(partition.nodes(root))
                    .enter().append("g");

            var path = g.append("path")
                    .attr("d", arc)
                    .style("fill", function (d) {
                        return color(d.name);//color((d.children ? d : d.parent).name);
                    })
                    .on("click", click);

//.append("text")
            var text = g.append("text")
                    .attr("x", function (d) {
                        return y(d.y);
                    })
                    .attr("dx", "6") // margin
                    .attr("dy", ".35em") // vertical-align
                    .attr("transform", function (d) {
                        var rotatedAngle = "rotate(" + computeTextRotation(d) + ")";
                        //console.log(computeTextRotation(d));
                        return rotatedAngle;
                    })
                    .text(function (d) {
                        if (d.children)
                            return d.name
                        else
                            return d.name + '. R$ ' + d.size
                    })
                    .style("fill", function (d) {
                        return brightness(d3.rgb(colour(d))) < 125 ? "#eee" : "#000";
                    })
                    ;

            function computeTextRotation(d) {
                var angle = x(d.x + d.dx / 2) - Math.PI / 2;
                return angle / Math.PI * 180;
            }

//text.attr("transform", function (d) {
//    return "rotate(" + computeTextRotation(d) + ")";
//});



            /*
             var label = g.append("rect")
             .attr("x", function(d) { return x(d.x) })
             .attr("y", function(d) { return y(d.y) })
             .attr("width", function(d) { return 100 })
             .attr("height", function(d) { return 100 })
             .attr("transform", function (d) {
             return "rotate(" + computeTextRotation(d) + ")";
             })
             .attr("style", "fill:blue;stroke:pink;stroke-width:5;fill-opacity:0.1;stroke-opacity:0.9");
             */

            function click(d) {
                // fade out all text elements
                if (d.size !== undefined) {
                    d.size += 100;
                }
                ;
                text.transition().attr("opacity", 0);

                path.transition()
                        .duration(750)
                        .attrTween("d", arcTween(d))
                        .each("end", function (e, i) {
                            // check if the animated element's data e lies within the visible angle span given in d
                            if (e.x >= d.x && e.x < (d.x + d.dx)) {
                                // get a selection of the associated text element
                                var arcText = d3.select(this.parentNode).select("text");
                                // fade in the text element and recalculate positions
                                arcText.transition().duration(750)
                                        .attr("opacity", 1)
                                        .attr("transform", function () {
                                            return "rotate(" + computeTextRotation(e) + ")"
                                        })
                                        .attr("x", function (d) {
                                            return y(d.y);
                                        });
                            }
                        });
            } //});

// Word wrap!
            var insertLinebreaks = function (t, d, width) {
                alert(0)
                var el = d3.select(t);
                var p = d3.select(t.parentNode);
                p.append("g")
                        .attr("x", function (d) {
                            return y(d.y);
                        })
//    .attr("dx", "6") // margin
//.attr("dy", ".35em") // vertical-align
                        .attr("transform", function (d) {
                            return "rotate(" + computeTextRotation(d) + ")";
                        })
//p
                        .append("foreignObject")
                        .attr('x', -width / 2)
                        .attr("width", width)
                        .attr("height", 200)
                        .append("xhtml:p")
                        .attr('style', 'word-wrap: break-word; text-align:center;')
                        .html(d.name);
                alert(1)
                el.remove();
                alert(2)
            };

//g.selectAll("text")
//    .each(function(d,i){ insertLinebreaks(this, d, 50 ); });

            function colour(d) {
//                if (d.children) {
//                    // There is a maximum of two children!
//                    var colours = d.children.map(colour),
//                            a = d3.hsl(colours[0]),
//                            b = d3.hsl(colours[1]);
//                    // L*a*b* might be better here...
//                    return d3.hsl((a.h + b.h) / 2, a.s * 1.2, a.l / 1.2);
//                }
                return  "#fff";
            }

            function brightness(rgb) {
                return rgb.r * .299 + rgb.g * .587 + rgb.b * .114;
            }
            d3.select(self.frameElement).style("height", height + "px");

// Interpolate the scales!
            function arcTween(d) {
                var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                        yd = d3.interpolate(y.domain(), [d.y, 1]),
                        yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
                return function (d, i) {
                    return i ? function (t) {
                        return arc(d);
                    } : function (t) {
                        x.domain(xd(t));
                        y.domain(yd(t)).range(yr(t));
                        return arc(d);
                    };
                };
            }

            function getData() {
                return {
                    "name": "Carteira TESTE DESENVOLVEDOR",
                    "children": [
                        {
                            "name": "Renda Fixa",
                            "children": [
                                {
                                    "name": "À Vista",
                                    "children": [
                                        {
                                            "name": "FTM CRI SERIE 130",
                                            "size": 23938
                                        }
                                    ]
                                },
                                {
                                    "name": "Compromissada",
                                    "children": [
                                        {
                                            "name": "COMP PÓS",
                                            "size": 13534
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Renda Variável",
                            "children": [
                                {
                                    "name": "À Vista",
                                    "children": [
                                        {
                                            "name": "ATMP1",
                                            "size": 721
                                        },
                                        {
                                            "name": "ATMP3 (1)",
                                            "size": 4294
                                        },
                                        {
                                            "name": "ATMP5",
                                            "size": 9800
                                        },
                                        {
                                            "name": "ATPR3",
                                            "size": 1314
                                        },
                                        {
                                            "name": "FTM DEPOSITO PN",
                                            "size": 2220
                                        },
                                        {
                                            "name": "FTM4 PN",
                                            "size": 2220
                                        },
                                        {
                                            "name": "FTM5",
                                            "size": 2220
                                        },
                                        {
                                            "name": "VALE3 AMP",
                                            "size": 2220
                                        }
                                    ]
                                },
                                {
                                    "name": "Opções",
                                    "children": [
                                        {
                                            "name": "AELP3OP AMP",
                                            "size": 721
                                        },
                                        {
                                            "name": "AELP3OP AMP",
                                            "size": 4294
                                        },
                                        {
                                            "name": "EMBR3OP AMP",
                                            "size": 9800
                                        },
                                        {
                                            "name": "EMBR3OP AMP",
                                            "size": 1314
                                        },
                                        {
                                            "name": "IBOV CAL A05",
                                            "size": 2220
                                        },
                                        {
                                            "name": "IBOV CAL A06",
                                            "size": 2220
                                        },
                                        {
                                            "name": "IBOV PUT A05",
                                            "size": 2220
                                        },
                                        {
                                            "name": "IBOV PUT A06",
                                            "size": 2220
                                        }
                                    ]
                                },
                                {
                                    "name": "Termo",
                                    "children": [
                                        {
                                            "name": "VALE3 AMP",
                                            "size": 721
                                        },
                                        {
                                            "name": "VALE3 AMP",
                                            "size": 4294
                                        }
                                    ]
                                },
                                {
                                    "name": "Empréstimo de Ações",
                                    "children": [
                                        {
                                            "name": "Tomador",
                                            "children": [
                                                {
                                                    "name": "ATMP3 (1)",
                                                    "size": 721
                                                },
                                                {
                                                    "name": "ATMP5",
                                                    "size": 4294
                                                },
                                                {
                                                    "name": "ATMP1",
                                                    "size": 4294
                                                },
                                                {
                                                    "name": "ATMP1",
                                                    "size": 4294
                                                }
                                            ]
                                        },
                                        {
                                            "name": "Doador",
                                            "children": [
                                                {
                                                    "name": "ATMP3 (1)",
                                                    "size": 721
                                                },
                                                {
                                                    "name": "ATMP5",
                                                    "size": 4294
                                                },
                                                {
                                                    "name": "ATMP1",
                                                    "size": 4294
                                                },
                                                {
                                                    "name": "ATPR3",
                                                    "size": 4294
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
            ;

        </script>
    </body>
</html>
