
<!DOCTYPE html>
<meta charset="utf-8">
<title>AMPLIS visualização de carteiras diárias</title>
<meta name="description" content="AMPLIS visualização de carteiras diárias.">


<link href="scripts/bootstrap.min.css" rel="stylesheet" type="text/css"/>

<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>

    body{
        background-image: url('fundo.png');
        background-repeat: no-repeat;
    }

    .carteirasTitle{
        font-family: "Arial";
        font-weight: bold; 
        font-size: 18px;
    }

    .chart {
        display: block;
        /*margin: auto;*/
        margin-top: 0px;
        font-size: 11px;     
        font-family: Arial;		

    }

    rect {
        stroke-width: 0.3;
        stroke: #fff;
        fill-opacity: .8;
    }

    rect.parent {
        cursor: pointer;
        fill: steelblue;
    }

    text {
        pointer-events: none;
    }


    /*    svg{
            margin-top: 130px;
            margin-left: -30px;
        }*/

    /*    #sequence {
            width: 600px;
            height: 70px;
            margin-top: 60px;
            margin-left: 280px;
    
        }*/

    #legend {
        padding: 10px 0 0 3px;
    }

    #sequence text, #legend text {
        /*        font-weight: 600;*/
        fill: #fff;
    }

    text {
        font: 11px Arial;
        cursor: pointer; 
    }

    text > tspan{
        font: 9px Arial;
        cursor: pointer;
    }

    .filterButtons{
        text-align: center;
        vertical-align: middle;
        line-height: 40px; 
        font-family: "Arial";
        font-weight: normal; 
        font-size: 11px;
    }

    .filterButtons:hover, .viewButtons:hover  {
        opacity: 0.75;
    }

    path {
        stroke: #fff;
        stroke-width: 0.3;
        cursor: pointer;
    }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }
    /*    #vis{
            margin-left: 280px;
        }*/

    .node text {
        font-family: Arial, sans-serif !important;
        font-size: 11px;
        cursor: pointer;
    }

    .node {
        cursor: pointer;
    }



</style>

<body>


    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>


    <div class="container-fluid" 
         style="margin-top: 50px; margin-left: 50px">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-10">

                        <div id="sequence"></div>

                        <div id="vis"></div>

                    </div>
                    <div class="col-md-2">
                        <div id="filterButtons"></div>
                        <div id="viewButtons"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <script src="//d3js.org/d3.v3.min.js"></script>

    <script>
        var viewId = 1;

        var fullJson;
        var filteredJson;
        var marginTopFirstFilterButton = 0;
        var firstSliceFilterButton = 0;
        var secondSliceFilterButton = 1;
        var selectedJsonIndex = 0;

        var r;
        var vis;
        var width = 700,
                sequenceWidth = 800;
        var totalSize = 0;

        var b = {
            w: 140, h: 30, s: 3, t: 10
        };

        var color = d3.scale.category20c();



        var i, tree, diagonal;


        var filterButtons = d3.select("#filterButtons");

        var margin = marginTopFirstFilterButton - 30;
        filterButtons.append("div")
                .attr("class", "carteirasTitle")
//                .style("margin-left", "50px")
//                .style("margin-top", margin + "px")
                .style("font-weight", "normal")
//                .style("position", "fixed")
                .text("Carteiras");
        ;



        var viewButtons = d3.select("#viewButtons");
        viewButtons.append("div")
                .attr("class", "carteirasTitle")
                .style("font-weight", "normal")
                .text("Views");

        viewButtons.append("img").attr("src", "partition.png").attr("width", "60px").attr('onclick', 'switchView(-1)').attr('class', 'viewButtons').attr('title', 'Partition').style("cursor", "pointer");
        viewButtons.append("img").attr("src", "sunburst.png").attr("width", "80px").attr('onclick', 'switchView(0)').attr('class', 'viewButtons').attr('title', 'Sunburst').style("cursor", "pointer");
        viewButtons.append("img").attr("src", "collapsible.png").attr("width", "80px").attr('onclick', 'switchView(1)').attr('class', 'viewButtons').attr('title', 'Collapsible').style("cursor", "pointer");



        d3.json("scripts/d3/carteiras.json", function (error, root) {
            if (error) {
                console.log(error);
                root = "";
            }

            if (root.length === 0) {
                return;
            }

            fullJson = root;
            fullJson.forEach(function (r_) {

                r = r_;
                filterButtons.append("div")
                        .text(r.name)
                        .attr("class", "filterButtons")
                        .attr("onclick", "updateVisualization(" + firstSliceFilterButton + "," + secondSliceFilterButton + ")")
//                        .style("position", "fixed")
//                        .style("margin-top", marginTopFirstFilterButton + "px")
//                        .style("margin-left", "50px")
                        .style("background-color", color(r.name))
                        .style("border", "0px")
                        .style("height", "40px")
//                        .style("width", "200px")
                        .style("cursor", "pointer")
                        .style("color", brightness(d3.rgb(color(r.name))) < 125 ? "#eee" : "#000")
                        ;
                marginTopFirstFilterButton = 0;
                firstSliceFilterButton++;
                secondSliceFilterButton++;


            });

            updateVisualization(0, 1);

        });

        function brightness(rgb) {
            return rgb.r * .299 + rgb.g * .587 + rgb.b * .114;
        }

//        function initializeBreadcrumbTrail() {
//            // Add the svg area.
//            
//            var trail = d3.select("#sequence").append("svg:svg")
//                    .attr("width", sequenceWidth)
//                    .attr("height", 50)
//                    .attr("id", "trail");
//            // Add the label at the end, for the percentage.
//            trail.append("svg:text")
//                    .attr("id", "endlabel")
//                    .style("fill", "#000");
//        }

        function getAncestors(node) {
            var path = [];
            var current = node;
            while (current.parent) {
                path.unshift(current);
                current = current.parent;
            }
            return path;
        }

        function breadcrumbPoints(d, i) {
            var points = [];
            points.push("0,0");
            points.push(b.w + ",0");
            points.push(b.w + b.t + "," + (b.h / 2));
            points.push(b.w + "," + b.h);
            points.push("0," + b.h);
            if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
                points.push(b.t + "," + (b.h / 2));
            }
            return points.join(" ");
        }
        function updateBreadcrumbs(nodeArray, percentageString) {

            // Data join; key function combines name and depth (= position in sequence).
            var g = d3.select("#trail")
                    .selectAll("g")
                    .data(nodeArray, function (d) {
                        return d.name + d.depth;
                    });

            // Add breadcrumb and label for entering nodes.
            var entering = g.enter().append("svg:g");


            entering.append("svg:polygon")
                    .attr("points", breadcrumbPoints)
                    .style("fill", function (d) {
                        return color(d.name);
                    })
                    ;

            entering.append("svg:text")
                    .attr("x", (b.w + b.t) / 2)
                    .attr("y", b.h / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .style("fill", function (d) {
                        return brightness(d3.rgb(color(d.name))) < 125 ? "#eee" : "#000";
                    })
                    .text(function (d) {
                        return d.name;
                    });

            // Set position for entering and updating nodes.
            g.attr("transform", function (d, i) {
                return "translate(" + i * (b.w + b.s) + ", 0)";
            });

            // Remove exiting nodes.
            g.exit().remove();

            // Now move and update the percentage at the end.
            d3.select("#trail").select("#endlabel")
                    .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
                    .attr("y", b.h / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .text(percentageString);

            // Make the breadcrumb trail visible, if it's hidden.
            d3.select("#trail")
                    .style("visibility", "");

        }
        function mouseover(d) {
            var percentage = d3.format("$,.2f")(d.value);


            console.log('------- ' + d.value);


            var percentageString = "R" + percentage;
            if (percentage < 0.1) {
                percentageString = "< 0.1%";
            }

            var sequenceArray = getAncestors(d);

            updateBreadcrumbs(sequenceArray, percentageString);

            // Fade all the segments.
            d3.selectAll("rect, #vis text")
                    .style("opacity", 0.2);

            // Then highlight only those that are an ancestor of the current segment.
            d3.selectAll("rect, #vis text")
                    .filter(function (node) {
                        return (sequenceArray.indexOf(node) >= 0) || !node.parent;
                    })
                    .style("opacity", 1);

        }

        function mouseleaveG(d) {
            d3.selectAll(".percentage")
                    .transition()
                    .duration(300)
                    .style("visibility", "hidden")
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseover);
                    });
        }
        function mouseleave(d) {

            d3.select("#trail")
                    .style("visibility", "hidden");

            // Deactivate all segments during transition.
            d3.selectAll("rect").on("mouseover", null);

            // Transition each segment to full opacity and then reactivate it.
            d3.selectAll("rect")
                    .transition()
                    .duration(300)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseover);
                    });

            d3.selectAll("text")
                    .transition()
                    .duration(300)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseover);
                    });

            d3.selectAll("#valoresItemSub").remove();

        }

        function updateVisualization(start, end) {

            d3.selectAll("#vis > .chart").remove();
            d3.selectAll("#sequence > svg").remove();
            d3.select("#container").remove();

            selectedJsonIndex = start;

            if (viewId === -1) {

                var w = 970,
                        h = 600,
                        x = d3.scale.linear().range([0, w]),
                        y = d3.scale.linear().range([0, h]);



                var r = fullJson.slice(start, end)[0];

                // initializeBreadcrumbTrail();        
                vis = d3.select("#vis").append("div")
                        .attr("class", "chart")
                        .style("width", w + "px")
                        .style("height", h + "px")
                        .append("svg:svg")
                        .attr("width", w)
                        .attr("height", h);



                var trail = d3.select("#sequence").append("svg:svg")
                        .attr("width", sequenceWidth)
                        .attr("height", 50)
                        .attr("id", "trail");
                // Add the label at the end, for the percentage.
                trail.append("svg:text")
                        .attr("id", "endlabel")
                        .style("fill", "#000");


                var partition = d3.layout.partition()
                        .value(function (d) {
                            return d.size;
                        });

                var g = vis.selectAll("g")
                        .data(partition.nodes(r))
                        .enter().append("svg:g")
                        .attr("transform", function (d) {
                            return "translate(" + x(d.y) + "," + y(d.x) + ")";
                        })
                        .on("click", function (d) {
                            if (d.children) {
                                return click(d);
                            } else {
                                return null;
                            }
                        })
                        .on("mouseover", mouseover)
                        .on("mouseleave", mouseleaveG);

                d3.select("#vis > .chart > svg").on("mouseleave", mouseleave);

                var kx = w / r.dx,
                        ky = h / 1;

                g.append("svg:rect")
                        .attr("width", r.dy * kx)
                        .attr("height", function (d) {
                            return d.dx * ky;
                        })
                        .attr("class", function (d) {
                            return d.children ? "parent" : "child";
                        })
                        .style("fill", function (d) {
                            //if (d.children) {
                            return color(d.name);
                            //} else {
                            //    return "lightgray";
                            //}

                        });

                g.append("svg:text")
                        .attr("transform", transform)
                        .attr("class", 'ativo')
                        .attr("dy", ".35em")
                        .style("opacity", function (d) {
                            return d.dx * ky > 12 ? 1 : 0;
                        })
                        .text(function (d) {
                            return d.name;
                        })
                        .style("fill", function (d) {
                            if (!d.children) {
                                return "#333333";
                            }
                            return brightness(d3.rgb(color(d.name))) < 125 ? "#eee" : "#000";
                        })
                        .style("font-size", function (d) {
                            if (!d.children) {
                                var hei = (d.dx * ky) * 0.5;
                                var res = hei > 11 ? 11 : Math.trunc(hei);
                                return res + 'px';
                            }

                        });

                g.append("svg:text")
                        .attr("transform", transform)
                        .attr("class", "percentage")
                        .style("visibility", "hidden")
                        .attr("dy", ".35em")
                        .attr("dx", r.dy * kx * 0.75)
                        .style("opacity", function (d) {
                            return d.dx * ky > 12 ? 1 : 0;
                        })
                        .text(function (d) {
                            var roundTwo = (d.dx * ky * 100 / h);
                            roundTwo = parseFloat(Math.round(roundTwo * 100) / 100).toFixed(2);
                            return roundTwo + '%';
                        })
                        .style("fill", function (d) {
                            if (!d.children) {
                                return "#333333";
                            }
                            return brightness(d3.rgb(color(d.name))) < 125 ? "#eee" : "#000";
                        })
                        .style("font-size", function (d) {
                            if (!d.children) {
                                var hei = (d.dx * ky) * 0.5;
                                return hei > 11 ? 11 : hei;
                            }

                        });

//            d3.select(window)
//                    .on("click", function () {
//                        click(r);
//                    });


                function click(d) {

                    kx = (d.y ? w - 40 : w) / (1 - d.y);
                    ky = h / d.dx;
                    x.domain([d.y, 1]).range([d.y ? 40 : 0, w]);
                    y.domain([d.x, d.x + d.dx]);

                    var t = g
                            .transition()
                            .duration(500)//d3.event.altKey ? 7500 : 750)
                            .attr("transform", function (d) {
                                return "translate(" + x(d.y) + "," + y(d.x) + ")";
                            })
                            ;

                    t.select("rect")
                            .attr("width", d.dy * kx)
                            .attr("height", function (d) {
                                return d.dx * ky;
                            });

                    t.select(".percentage")
                            .attr("transform", transform);

                    t.select("text")
                            .attr("transform", transform)
                            .style("opacity", function (d) {
                                return d.dx * ky > 12 ? 1 : 0;
                            })
                            .style("font-size", function (d) {
                                if (!d.children) {
                                    var hei = (d.dx * ky) * 0.5;
                                    var res = hei > 11 ? 11 : Math.trunc(hei);
                                    return res + 'px';
                                }

                            });

                    d3.event.stopPropagation();
                }

                function transform(d) {

                    return "translate(8," + d.dx * ky / 2 + ")";
                }
            } else if (viewId === 0) {

                d3.selectAll("#vis > .chart").remove();
                d3.selectAll("#sequence > svg").remove();
                d3.select("#container").remove();

                updateVisualizationSunburst(start, end);

                var path = d3.select('#container  g  path');
                path.on('click').call(path.node(), path.datum());

            } else if (viewId === 1) {

                d3.selectAll("#vis > .chart").remove();
                d3.selectAll("#sequence > svg").remove();
                d3.select("#container").remove();

                var margin = {top: 180, right: 120, bottom: 20, left: 180},
                width = 1200 - margin.right - margin.left,
                        height = 900;


                i = 0,
                        duration = 750,
                        root = filteredJson;


                tree = d3.layout.tree()
                        .size([height, width]);

                diagonal = d3.svg.diagonal()
                        .projection(function (d) {
                            return [d.y, d.x];
                        });

                vis = div.append("svg")
                        .attr("id", "container")
                        .attr("width", width + margin.right + margin.left)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")

                        .attr("transform", "translate(120,0)");

                source = fullJson.slice(start, end)[0];
                source.x0 = height / 2;
                source.y0 = 0;

                updateVisualizationCollapsible(source);


            }

        }

        function switchView(viewNumber) {
            viewId = viewNumber;
            updateVisualization(selectedJsonIndex, selectedJsonIndex + 1);
            console.log('switching view ' + viewId);
        }


        var div = d3.select("#vis");
        var padding = 5,
                duration = 1000,
                height = 700,
                width = height,
                radius = width / 2,
                x = d3.scale.linear().range([0, 2 * Math.PI]),
                y = d3.scale.pow().exponent(1.3).domain([0, 1]).range([0, radius]);

        var vis;
        var arc;
        function updateVisualizationSunburst(startIndexToShow, endIndexToShow) {

            vis = div.append("svg")
                    .attr("width", width + padding * 2)
                    .attr("height", height + padding * 2)
                    .attr("id", "container")
                    .append("g")
                    .attr("transform", "translate(" + [radius + padding, radius + padding] + ")");


// Define the div for the tooltip
            //var div2 = d3.select("body").append("div")
            //         .attr("class", "tooltip")
            //       .style("opacity", 0);

            div.select("img").remove();

            //div.remove("svg");



            var partition = d3.layout.partition()
                    .sort(null)
                    .value(function (d) {
                        return  d.size;
                    });

            arc = d3.svg.arc()
                    .startAngle(function (d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
                    })
                    .endAngle(function (d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
                    })
                    .innerRadius(function (d) {
                        return Math.max(0, d.y ? y(d.y) : d.y);
                    })
                    .outerRadius(function (d) {
                        return Math.max(0, y(d.y + d.dy));
                    });


            initializeBreadcrumbTrail();

            loadedJSON = fullJson;
            loadedJSON = loadedJSON.slice(startIndexToShow, endIndexToShow);

            nodes = partition.nodes(
                    {
                        children: loadedJSON
                    }
            );

//        nodes = nodes.filter(function (d) {
//            
//            if(d.depth === 2){
//                return d;
//            }
//            
//        });

            path = vis.selectAll("path").data(nodes);

            //  d3.selectAll("path").on('click',function(){console.log("removedlllll");});

            path.enter().append("path")
                    .attr("id", function (d, i) {
                        return "path-" + i;
                    })
                    .attr("d", arc)
                    .attr("fill-rule", "evenodd")
                    .style("fill", function (d) {
                        return color(d.name);//color((d.children ? d : d.parent).name);
                    })
//                .attr("display", function (d) {
//                    return (d.depth === 1) ? null : "none";
//                }) // hide inner
                    .on("click", click)
                    .on("mouseover", mouseoverSunburst)
                    ;

            d3.select("#container").on("mouseleave", mouseleaveSunburst);

            text = vis.selectAll("text").data(nodes);
            textEnter = text.enter().append("text")
                    .style("fill-opacity", 1)
                    .style("fill", function (d) {
                        return brightness(d3.rgb(color(d.name))) < 125 ? "#eee" : "#000";
                    })
                    .attr("text-anchor", function (d) {
                        return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
                    })
                    .attr("dy", ".2em")
                    .attr("transform", function (d) {
                        var multiline = (d.name || "").split(" ").length > 1,
                                angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
                                rotate = angle + (multiline ? -.5 : 0);
                        return "rotate(" + rotate + ")translate(" + (y(d.y) + padding) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
                    })
                    .on("click", click);
            textEnter.append("tspan")
                    .attr("x", 0)
                    .text(function (d) {
                        return d.depth ? d.name.split(" ")[0] : "";
                    })
//                    .style("font-size", function (d) {
//                        if (!d.children) {
//                            return '7px';
//                        }
//
//                    })
                    ;
            textEnter.append("tspan")
                    .attr("x", 0)
                    .attr("dy", "1em")
                    .text(function (d) {
                        return d.depth ? d.name.split(" ")[1] || "" : "";
                    })
//                    .style("font-size", function (d) {
//                        if (!d.children) {
//                            return '7px';
//                        }
//
//                    })
                    ;


            totalSize = path.node().__data__.value;


        }

        function click(d) {

            path.transition()
                    .duration(duration)
                    .attrTween("d", arcTween(d));

            // Somewhat of a hack as we rely on arcTween updating the scales.
            text.style("visibility", function (e) {
                return isParentOf(d, e) ? null : d3.select(this).style("visibility");
            }).transition()
                    .duration(duration)
                    .attrTween("text-anchor", function (d) {
                        return function () {
                            return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
                        };
                    })
                    .attrTween("transform", function (d) {
                        var multiline = (d.name || "").split(" ").length > 1;
                        return function () {
                            var angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
                                    rotate = angle + (multiline ? -.5 : 0);
                            return "rotate(" + rotate + ")translate(" + (y(d.y) + padding) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
                        };
                    })
                    .style("fill-opacity", function (e) {
                        return isParentOf(d, e) ? 1 : 1e-6;
                    })
                    .each("end", function (e) {
                        d3.select(this).style("visibility", isParentOf(d, e) ? null : "hidden");
                    });
        }


        function mouseoverSunburst(d) {

//        div2.transition()
//                .duration(200)
//                .style("opacity", .9);
//        if (d.parent) {
//            div2.html(
//                    d.name + "<br/>" + (d.children ? "" : "R" + d3.format("$,.2f")(d.size))
//                    )
//                    .style("left", (d3.event.pageX) + "px")
//                    .style("top", (d3.event.pageY - 28) + "px");
//        }
            var percentage = d3.format("$,.2f")(d.value);//(100 * d.value / totalSize).toPrecision(3);
            var percentageString = "R" + percentage;
            if (percentage < 0.1) {
                percentageString = "< 0.1%";
            }
//
//        d3.select("#percentage")
//                .text(percentageString);

//        d3.select("#explanation")
//                .style("visibility", "");

            var sequenceArray = getAncestors(d);
            updateBreadcrumbs(sequenceArray, percentageString);

            // Fade all the segments.
            d3.selectAll("path, #vis text")
                    .style("opacity", 0.3);

            // Then highlight only those that are an ancestor of the current segment.
            vis.selectAll("path, #vis text")
                    .filter(function (node) {
                        return (sequenceArray.indexOf(node) >= 0);
                    })
                    .style("opacity", 1);

        }

// Restore everything to full opacity when moving off the visualization.
        function mouseleaveSunburst(d) {



//        div2.transition()
//                .duration(500)
//                .style("opacity", 0);
            // Hide the breadcrumb trail
            d3.select("#trail")
                    .style("visibility", "hidden");

            // Deactivate all segments during transition.
            d3.selectAll("path").on("mouseover", null);

            // Transition each segment to full opacity and then reactivate it.
            d3.selectAll("path")
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseoverSunburst);
                    });

            d3.selectAll("text")
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseoverSunburst);
                    });

            d3.selectAll("#valoresItemSub").remove();
//        d3.select("#explanation")
//                .style("visibility", "hidden");
        }
        function getAncestors(node) {
            var path = [];
            var current = node;
            while (current.parent) {
                path.unshift(current);
                current = current.parent;
            }
            return path;
        }

        // Interpolate the scales!
        function arcTween(d) {
            var my = maxY(d),
                    xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                    yd = d3.interpolate(y.domain(), [d.y, my]),
                    yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
            return function (d) {
                return function (t) {
                    x.domain(xd(t));
                    y.domain(yd(t)).range(yr(t));
                    return arc(d);
                };
            };
        }

        function maxY(d) {
            return d.children ? Math.max.apply(Math, d.children.map(maxY)) : d.y + d.dy;
        }

        function isParentOf(p, c) {
            if (p === c)
                return true;
            if (p.children) {
                return p.children.some(function (d) {
                    return isParentOf(d, c);
                });
            }
            return false;
        }

        function initializeBreadcrumbTrail() {
            // Add the svg area.
            var trail = d3.select("#sequence").append("svg:svg")
                    .attr("width", sequenceWidth)
                    .attr("height", 50)
                    .attr("id", "trail");
            // Add the label at the end, for the percentage.
            trail.append("svg:text")
                    .attr("id", "endlabel")
                    .style("fill", "#000");
        }




        function updateVisualizationCollapsible(source) {



            // Compute the new tree layout.
            var nodes = tree.nodes(source).reverse(),
                    links = tree.links(nodes);

            // Normalize for fixed-depth.
            nodes.forEach(function (d) {
                d.y = d.depth * 180;
            });




            initializeBreadcrumbTrail();
            // Update the nodes…
            var node = vis.selectAll("g.node")
                    .data(nodes, function (d) {
                        return d.id || (d.id = ++i);
                    });

            // Enter any new nodes at the parent's previous position.
            var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + source.y0 + "," + source.x0 + ")";
                    })
                    .on("mouseover", mouseoverCollapsible)
                    // .on("mouseleave", mouseleaveCollapsible)
                    .on("click", clickCollapsible);

            d3.select("#container").on("mouseleave", mouseleaveCollapsible);
//svg.selectAll("g").data(nodes);

            nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    .style("fill", function (d) {
                        return d._children ? "lightsteelblue" : "#fff";
                    })
                    ;

            nodeEnter.append("text")
                    .attr("x", function (d) {
                        return d.children || d._children ? -10 : 10;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function (d) {
                        return d.children || d._children ? "end" : "start";
                    })
                    .text(function (d) {
                        return d.children || d._children ? d.name : d.name + ' [R' + d3.format("$,.2f")(d.size) + ']';
                    })
                    .style("fill-opacity", 1e-6);

            // Transition nodes to their new position.
            var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

            nodeUpdate.select("circle")
                    //.attr("r", 4.5)
                    .attr("r", 6.0)
                    .style("fill", function (d) {
                        return color(d.name);
                        //d._children ? "lightsteelblue" : "#fff";
                    });

            nodeUpdate.select("text")
                    .style("fill-opacity", 1);

            // Transition exiting nodes to the parent's new position.
            var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + source.y + "," + source.x + ")";
                    })
                    .remove();

            nodeExit.select("circle")
                    .attr("r", 1e-6);

            nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

            // Update the links…
            var link = vis.selectAll("path.link")
                    .data(links, function (d) {
                        return d.target.id;
                    });

            // Enter any new links at the parent's previous position.
            link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function (d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

            // Transition links to their new position.
            link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

            // Transition exiting nodes to the parent's new position.
            link.exit().transition()
                    .duration(duration)
                    .attr("d", function (d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

            // Stash the old positions for transition.
            nodes.forEach(function (d) {
                d.x0 = d.x;
                d.y0 = d.y;
            });

        }

        function clickCollapsible(d) {
            temp = d;
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }

            updateCollapsible(d);
        }

        function updateCollapsible(source) {

            // Compute the new tree layout.
            var nodes = tree.nodes(filteredJson).reverse(), ////////////////
                    links = tree.links(nodes);

            // Normalize for fixed-depth.
            nodes.forEach(function (d) {
                d.y = d.depth * 180;
            });

            initializeBreadcrumbTrail();
            // Update the nodes…
            var node = svg.selectAll("g.node")
                    .data(nodes, function (d) {
                        return d.id || (d.id = ++i);
                    });

            // Enter any new nodes at the parent's previous position.
            var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + source.y0 + "," + source.x0 + ")";
                    })
                    .on("mouseover", mouseoverCollapsible)
                    // .on("mouseleave", mouseleaveCollapsible)
                    .on("click", clickCollapsible);

            d3.select("#container").on("mouseleave", mouseleaveCollapsible);
//svg.selectAll("g").data(nodes);

            nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    .style("fill", function (d) {
                        return d._children ? "lightsteelblue" : "#fff";
                    })
                    ;

            nodeEnter.append("text")
                    .attr("x", function (d) {
                        return d.children || d._children ? -10 : 10;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function (d) {
                        return d.children || d._children ? "end" : "start";
                    })
                    .text(function (d) {
                        return d.children || d._children ? d.name : d.name + ' [R' + d3.format("$,.2f")(d.size) + ']';
                    })
                    .style("fill-opacity", 1e-6);

            // Transition nodes to their new position.
            var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

            nodeUpdate.select("circle")
                    //.attr("r", 4.5)
                    .attr("r", 6.0)
                    .style("fill", function (d) {
                        return color(d.name);
                        //d._children ? "lightsteelblue" : "#fff";
                    });

            nodeUpdate.select("text")
                    .style("fill-opacity", 1);

            // Transition exiting nodes to the parent's new position.
            var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + source.y + "," + source.x + ")";
                    })
                    .remove();

            nodeExit.select("circle")
                    .attr("r", 1e-6);

            nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

            // Update the links…
            var link = svg.selectAll("path.link")
                    .data(links, function (d) {
                        return d.target.id;
                    });

            // Enter any new links at the parent's previous position.
            link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function (d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

            // Transition links to their new position.
            link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

            // Transition exiting nodes to the parent's new position.
            link.exit().transition()
                    .duration(duration)
                    .attr("d", function (d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

            // Stash the old positions for transition.
            nodes.forEach(function (d) {
                d.x0 = d.x;
                d.y0 = d.y;
            });




            //  totalSize = node.node().__data__.value;

        }


        function mouseoverCollapsible(d) {

            //if (d.children === undefined) {
            var percentage = d3.format("$,.2f")(d.value);

            var percentageString = "R" + percentage;

            var sequenceArray = getAncestors(d);
            percentageString = '';
            updateBreadcrumbs(sequenceArray, percentageString);

            //}


        }

        function mouseleaveCollapsible(d) {


//        div2.transition()
//                .duration(500)
//                .style("opacity", 0);
            // Hide the breadcrumb trail
            d3.select("#trail")
                    .style("visibility", "hidden");

            // Deactivate all segments during transition.
            d3.selectAll("path").on("mouseover", null);

            // Transition each segment to full opacity and then reactivate it.
            d3.selectAll("path")
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseoverCollapsible);
                    });

            d3.selectAll("text")
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .each("end", function () {
                        d3.select(this).on("mouseover", mouseoverCollapsible);
                    });

            d3.selectAll("#valoresItemSub").remove();
//        d3.select("#explanation")
//                .style("visibility", "hidden");
        }

    </script>

</body>